rules_version = '2';

service cloud.firestore {
    match /databases/{database}/documents {
        match /gameSessions/{sessionId} {
            allow read: if request.auth != null;
            allow write: if request.auth != null &&
                    (
                    // Adding players: Only allow adding to `playerIds` if fewer than 2 players exist
                        (
                            request.resource.data.playerIds != resource.data.playerIds &&
                                resource.data.playerIds.size() < 2 &&
                                resource.data.gameStatus == 'waiting'
                        ) ||
                        // Updating scores: Only allow if `scores` field is being modified
                            (
                                request.resource.data.scores != resource.data.scores
                            ) ||
                        // Updating gameStatus: Only allow the host or players to change `gameStatus`
                            (
                                request.auth.uid in resource.data.playerIds &&
                                    request.resource.data.gameStatus != resource.data.gameStatus
                            ) ||
                        // Updating startTime: Only allow if the game is active
                            (
                                request.resource.data.startTime != resource.data.startTime &&
                                    resource.data.isActive == true
                            )
                    );
        }

        match /users/{uid} {
            allow read, write: if request.auth != null;
        }
    }
}